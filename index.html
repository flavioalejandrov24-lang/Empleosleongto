<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empleos Le√≥n GTO - Portal de Vacantes</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíº</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;overflow-x:hidden;color:#1a1a1a}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(50px) scale(0.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
.fade-in{animation:fadeIn .5s ease-out forwards}
.slide-in{animation:slideIn .3s ease-out forwards}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-window{background:white;border-radius:16px;box-shadow:0 25px 80px rgba(0,0,0,.4);max-width:500px;width:100%;overflow:hidden;border:1px solid rgba(255,255,255,.2)}
.modal-header{background:linear-gradient(135deg,#000 0%,#333 100%);color:white;padding:24px;display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px}
.modal-body{padding:28px;line-height:1.6;color:#495057}
.modal-footer{padding:20px 28px;background:#f8f9fa;display:flex;gap:12px;justify-content:flex-end;border-top:1px solid #e9ecef}
.btn{padding:12px 28px;border-radius:10px;font-weight:600;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);border:none;font-size:14px;text-transform:none;letter-spacing:.5px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 14px rgba(102,126,234,.4)}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 24px rgba(102,126,234,.5)}
.btn-cancel{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%);color:white;box-shadow:0 4px 14px rgba(220,53,69,.3);font-weight:700}
.btn-cancel:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(220,53,69,.4)}
.btn-outline{background:linear-gradient(135deg,white 0%,#f8f9fa 100%);border:2px solid #667eea;color:#667eea}
.btn-outline:hover:not(:disabled){background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}
.btn-autofill{background:linear-gradient(135deg,#000 0%,#333 100%);color:#FFD700;box-shadow:0 4px 14px rgba(0,0,0,.4);border:2px solid rgba(255,215,0,.3)}
.btn-autofill:hover:not(:disabled){background:linear-gradient(135deg,#1a1a1a 0%,#444 100%);transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.5)}
.btn-clean{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);color:#667eea;border:2px solid #667eea}
.btn-clean:hover:not(:disabled){background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;transform:translateY(-2px)}
.btn-save{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:white;box-shadow:0 4px 14px rgba(40,167,69,.3)}
.btn-save:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(40,167,69,.4)}
.input-group{position:relative;margin-bottom:20px}
.input-group input,.input-group textarea,.input-group select{width:100%;padding:14px 16px;border:2px solid #e9ecef;border-radius:10px;font-size:14px;transition:all .2s;font-family:inherit;text-transform:none}
.input-group input:focus,.input-group textarea:focus,.input-group select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.1)}
.input-group label{display:block;margin-bottom:8px;font-weight:600;color:#495057;font-size:13px;text-transform:none;letter-spacing:.5px}
.input-icon{position:absolute;right:16px;top:42px;cursor:pointer;color:#6c757d;transition:color .2s;user-select:none}
.input-icon:hover{color:#667eea}
.alert{padding:16px 20px;border-radius:12px;margin-bottom:20px;display:flex;align-items:center;gap:12px;font-size:14px;animation:slideIn .3s ease-out;font-weight:500}
.alert-success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
.alert-error{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
.alert-warning{background:#fff3cd;color:#856404;border-left:4px solid #ffc107}
.alert-info{background:#d1ecf1;color:#0c5460;border-left:4px solid #17a2b8}
.vacancy-card{background:white;border-radius:24px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.1);transition:all .3s cubic-bezier(.4,0,.2,1);border:2px solid transparent}
.vacancy-card:hover{transform:translateY(-8px);box-shadow:0 20px 50px rgba(0,0,0,.2);border-color:rgba(102,126,234,.3)}
.loader{border:4px solid #f3f4f6;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin .8s linear infinite;margin:20px auto}
.line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ai-chat-modal{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:400px;max-height:600px;z-index:9999;animation:slideUp .4s ease-out;background:white;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4);border:2px solid rgba(0,0,0,.2)}
.ai-chat-header{background:linear-gradient(135deg,#000 0%,#333 100%);color:#FFD700;padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center;cursor:move;font-weight:700;font-size:18px;text-shadow:0 0 10px rgba(255,215,0,.7)}
.ai-chat-header h3{margin:0;color:#FFD700}
.ai-chat-header .close-btn{background:rgba(255,255,255,.1);border:none;color:#FFD700;width:32px;height:32px;border-radius:50%;cursor:pointer;transition:all .3s ease;margin-left:12px}
.ai-chat-header .close-btn:hover{background:rgba(255,215,0,.2);transform:rotate(90deg)}
.ai-chat-messages{background:rgba(0,0,0,.95);padding:20px;max-height:300px;overflow-y:auto;border-left:2px solid #FFD700;border-right:2px solid #FFD700}
.ai-message{margin-bottom:16px;padding:12px 16px;border-radius:12px;max-width:90%;word-wrap:break-word;font-size:14px;line-height:1.5}
.ai-message.user{background:linear-gradient(135deg,#2563eb 0%,#3b82f6 100%);color:white;margin-left:auto;border-top-right-radius:4px}
.ai-message.bot{background:linear-gradient(135deg,#1a1a1a 0%,#333 100%);color:#FFD700;border-top-left-radius:4px;border-left:3px solid #FFD700}
.ai-loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,215,0,.3);border-top-color:#FFD700;border-radius:50%;animation:spin 1s linear infinite}
.ai-chat-input{background:linear-gradient(135deg,#000 0%,#333 100%);padding:16px;border-radius:0 0 16px 16px}
.ai-chat-input textarea{width:100%;padding:12px 16px;border:2px solid #FFD700;border-radius:12px;background:rgba(255,255,255,.1);color:white;resize:none;font-family:inherit;font-size:14px;transition:all .3s ease}
.ai-chat-input textarea:focus{outline:none;border-color:#FFD700;box-shadow:0 0 15px rgba(255,215,0,.5)}
.ai-chat-input textarea::placeholder{color:rgba(255,255,255,.5)}
.ai-chat-actions{display:flex;gap:12px;margin-top:12px}
.ai-chat-actions button{flex:1;padding:12px 16px;border:none;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:8px}
.ai-chat-actions .btn-send{background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);color:white}
.ai-chat-actions .btn-send:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(59,130,246,.4)}
.ai-chat-actions .btn-start{background:linear-gradient(135deg,#16a34a 0%,#22c55e 100%);color:white;animation:pulse-gold 2s infinite}
@keyframes pulse-gold{0%,100%{opacity:1}50%{opacity:.5;transform:scale(1.1)}}
.ai-chat-actions .btn-start:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 8px 20px rgba(34,197,94,.4)}
.ai-chat-actions .btn-close-chat{background:linear-gradient(135deg,#dc3545 0%,#e83e8c 100%);color:white}
.ai-chat-actions .btn-close-chat:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(220,53,69,.4)}
.ai-chat-input .file-upload{display:flex;align-items:center;gap:12px;margin-top:12px}
.ai-chat-input .file-upload label{background:rgba(255,215,0,.2);color:#FFD700;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;transition:all .3s ease;border:1px solid rgba(255,215,0,.3)}
.ai-chat-input .file-upload label:hover{background:rgba(255,215,0,.3);transform:translateY(-1px)}
.ai-chat-input .file-upload input{display:none}
.ai-chat-input .file-preview{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);padding:8px 12px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,215,0,.2)}
.ai-chat-input .file-preview img{width:40px;height:40px;object-fit:cover;border-radius:6px}
.ai-chat-input .file-preview .remove-file{background:rgba(255,0,0,.3);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:12px}
.ai-chat-modal.minimized{width:280px;height:60px;max-height:60px}
.ai-chat-modal.minimized .ai-chat-messages,.ai-chat-modal.minimized .ai-chat-input{display:none}
.ai-chat-modal.minimized .ai-chat-header{border-radius:16px}
.ai-chat-modal.minimized .ai-chat-header h3{font-size:14px}
::-webkit-scrollbar{width:12px}
::-webkit-scrollbar-track{background:#f1f1f1}
::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:6px}
@media(max-width:768px){.ai-chat-modal{width:95%;max-width:95%}.modal-window{margin:20px}}
.form-buttons-container{display:flex;flex-direction:column;gap:12px}
@media (min-width:640px){.form-buttons-container{flex-direction:row}}
</style>
</head>
<body>
<div id="app"></div>
<div id="modal-root"></div>
<script>
console.log('üöÄ [INICIO] Cargando aplicaci√≥n Empleos Le√≥n GTO...');
// Configuraci√≥n de Supabase
const SUPABASE_URL = 'https://mecrloufrzbfcihioeve.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lY3Jsb3VmcnpiZmNpaGlvZXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NTM2OTgsImV4cCI6MjA4NjMyOTY5OH0.Gs36EkNHv5vG2CPdrK7XtCnWvX5NYkyPY9moTdezbVA';
const SUPABASE_REDIRECT_URL = 'https://flavioalejandrov24-lang.github.io/empleosleongto/';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
console.log('‚úÖ [SUPABASE] Cliente inicializado');

// Estado centralizado
let state = {
  view: 'login',
  user: null,
  isGuest: false,
  vacancies: [],
  editingVacancy: null,
  showPassword: false,
  showConfirmPassword: false,
  menuOpen: false,
  acceptedTerms: false,
  loading: false,
  formData: {
    email: '',
    password: '',
    confirmPassword: '',
    company: '',
    job_title: '',
    description: '',
    location: '',
    contact_phone: '',
    contact_email: '',
    schedule: '',
    work_days: '',
    imageUrl: ''
  },
  aiChatOpen: false,
  aiMessages: [],
  aiLoading: false,
  aiImage: null,
  aiImagePreview: null,
  aiExtractedData: null
};
console.log('‚úÖ [ESTADO] Estado inicializado');

// Variables para drag del chat
let isDragging = false;
let offsetX = 0, offsetY = 0;

// Funciones de utilidad
const showLoading = () => {
  console.log('‚è≥ [LOADING] Mostrando loader');
  state.loading = true;
  const loader = document.createElement('div');
  loader.id = 'loader-overlay';
  loader.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)';
  loader.innerHTML = '<div class="loader"></div>';
  document.body.appendChild(loader);
};

const hideLoading = () => {
  console.log('‚úÖ [LOADING] Ocultando loader');
  state.loading = false;
  const loader = document.getElementById('loader-overlay');
  if (loader) loader.remove();
};

const showModal = (type, title, message) => {
  console.log(`üì¢ [MODAL] ${type.toUpperCase()}: ${title} - ${message}`);
  const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
  const colors = {
    success: 'linear-gradient(135deg,#28a745 0%,#20c997 100%)',
    error: 'linear-gradient(135deg,#dc3545 0%,#e83e8c 100%)',
    warning: 'linear-gradient(135deg,#ffc107 0%,#fd7e14 100%)',
    info: 'linear-gradient(135deg,#17a2b8 0%,#20c997 100%)'
  };
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-window">
      <div class="modal-header" style="background:${colors[type]}">
        <span style="font-size:28px">${icons[type]}</span>
        <span>${title}</span>
      </div>
      <div class="modal-body">
        <p>${message}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
          <i class="fas fa-check"></i> Aceptar
        </button>
      </div>
    </div>
  `;
  document.getElementById('modal-root').appendChild(modal);
  modal.addEventListener('click', e => {
    if (e.target === modal) modal.remove();
  });
  setTimeout(() => { if (modal.parentNode) modal.remove(); }, 8000);
};

// üîß FUNCI√ìN CORREGIDA: Limpiar datos de la IA (quitar may√∫sculas forzadas)
function cleanAIData(data) {
  const cleaned = {};
  for (const key in data) {
    if (data[key] && typeof data[key] === 'string') {
      // Convertir a may√∫sculas solo la primera letra de cada palabra
      cleaned[key] = data[key].toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    } else {
      cleaned[key] = data[key];
    }
  }
  return cleaned;
}

// üîß FUNCI√ìN CORREGIDA: Limpiar tel√©fono (quitar espacios y caracteres no num√©ricos)
function cleanPhoneNumber(phone) {
  if (!phone) return '';
  return phone.toString().replace(/\D/g, '');
}

// Funciones de autenticaci√≥n
async function handleLogin(e) {
  e.preventDefault();
  console.log('üîê [LOGIN] Intentando iniciar sesi√≥n');
  showLoading();
  try {
    const email = state.formData.email.trim();
    const password = state.formData.password;
    if (!email || !password) {
      throw new Error('Correo y contrase√±a son requeridos');
    }
    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) throw error;
    console.log('‚úÖ [LOGIN] Sesi√≥n iniciada exitosamente');
    state.user = data.user;
    const accepted = localStorage.getItem('terms_accepted_' + data.user.id);
    state.acceptedTerms = !!accepted;
    state.view = accepted ? 'dashboard' : 'terms';
    await loadVacancies();
    render();
    showModal('success', 'Bienvenido', 'Has iniciado sesi√≥n correctamente');
  } catch (error) {
    console.error('‚ùå [LOGIN] Error:', error);
    showModal('error', 'Error de inicio de sesi√≥n', error.message || 'Correo o contrase√±a incorrectos');
  } finally {
    hideLoading();
  }
}

async function handleSignup(e) {
  e.preventDefault();
  console.log('üìù [SIGNUP] Intentando registrar usuario');
  if (state.formData.password !== state.formData.confirmPassword) {
    console.log('‚ùå [SIGNUP] Contrase√±as no coinciden');
    return showModal('error', 'Error', 'Las contrase√±as no coinciden');
  }
  if (state.formData.password.length < 6) {
    console.log('‚ùå [SIGNUP] Contrase√±a muy corta');
    return showModal('error', 'Error', 'La contrase√±a debe tener al menos 6 caracteres');
  }
  showLoading();
  try {
    const email = state.formData.email.trim().toLowerCase();
    const { data, error } = await supabaseClient.auth.signUp({
      email,
      password: state.formData.password,
      options: { emailRedirectTo: SUPABASE_REDIRECT_URL }
    });
    if (error) throw error;
    console.log('‚úÖ [SIGNUP] Registro exitoso');
    showModal('success', 'Registro exitoso', 'Revisa tu correo para confirmar tu cuenta. Luego podr√°s iniciar sesi√≥n.');
    state.view = 'login';
    resetAuthForm();
    render();
  } catch (error) {
    console.error('‚ùå [SIGNUP] Error:', error);
    showModal('error', 'Error', error.message.includes('already registered') ? 'Este correo ya est√° registrado' : error.message);
  } finally {
    hideLoading();
  }
}

// Funciones de vacantes
async function loadVacancies() {
  console.log('üì• [VACANCIES] Cargando vacantes...');
  try {
    const { data, error } = await supabaseClient.from('vacancies').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    state.vacancies = data || [];
    console.log(`‚úÖ [VACANCIES] Cargadas ${state.vacancies.length} vacantes`);
    render();
  } catch (error) {
    console.error('‚ùå [VACANCIES] Error:', error);
    showModal('error', 'Error', 'No se pudieron cargar las vacantes');
  }
}

async function handleImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  console.log('üñºÔ∏è [UPLOAD] Archivo seleccionado:', file.name, file.size);
  if (file.size > 2 * 1024 * 1024) {
    console.log('‚ùå [UPLOAD] Archivo demasiado grande');
    showModal('error', 'Archivo muy grande', 'M√°ximo 2MB');
    e.target.value = '';
    return;
  }
  if (!file.type.startsWith('image/')) {
    console.log('‚ùå [UPLOAD] Tipo de archivo inv√°lido');
    showModal('error', 'Tipo inv√°lido', 'Solo im√°genes');
    e.target.value = '';
    return;
  }
  showLoading();
  try {
    const fileExt = file.name.split('.').pop();
    const fileName = `${state.user.id}/${Date.now()}.${fileExt}`;
    console.log('üì§ [UPLOAD] Subiendo a Supabase:', fileName);
    const { error } = await supabaseClient.storage.from('vacancy-images').upload(fileName, file);
    if (error) throw error;
    const { data: urlData } = supabaseClient.storage.from('vacancy-images').getPublicUrl(fileName);
    state.formData.imageUrl = urlData.publicUrl;
    console.log('‚úÖ [UPLOAD] Imagen subida:', state.formData.imageUrl);
    render();
    showModal('success', 'Imagen cargada', '‚úì');
  } catch (error) {
    console.error('‚ùå [UPLOAD] Error:', error);
    showModal('error', 'Error al subir', error.message);
    e.target.value = '';
  } finally {
    hideLoading();
  }
}

// üîß FUNCI√ìN CORREGIDA: Evitar guardado autom√°tico + limpiar datos
async function handleSaveVacancy(e) {
  e.preventDefault(); // üî• PREVENIR ENV√çO AUTOM√ÅTICO
  console.log('üíæ [SAVE] Guardando vacante...');
  
  // Validaciones
  if (!state.formData.company || !state.formData.job_title || !state.formData.description) {
    console.log('‚ùå [SAVE] Campos requeridos incompletos');
    return showModal('error', 'Campos requeridos', 'Completa empresa, puesto y descripci√≥n');
  }
  if (!state.formData.imageUrl) {
    console.log('‚ùå [SAVE] Imagen no subida');
    return showModal('error', 'Imagen requerida', 'Sube una imagen');
  }
  
  // Limpiar tel√©fono antes de guardar
  const cleanPhone = cleanPhoneNumber(state.formData.contact_phone);
  if (cleanPhone && (cleanPhone.length < 10 || cleanPhone.length > 16)) {
    console.log('‚ùå [SAVE] Tel√©fono inv√°lido:', cleanPhone);
    return showModal('error', 'Tel√©fono inv√°lido', 'Debe tener 10-16 d√≠gitos');
  }

  showLoading();
  try {
    const vacancyData = {
      user_id: state.user.id,
      company: state.formData.company.trim(),
      job_title: state.formData.job_title.trim(),
      description: state.formData.description.trim(),
      location: state.formData.location.trim() || 'Le√≥n, Guanajuato',
      contact_phone: cleanPhone, // üî• TEL√âFONO LIMPIO
      contact_email: state.formData.contact_email.trim(),
      schedule: state.formData.schedule.trim(),
      work_days: state.formData.work_days.trim(),
      image_url: state.formData.imageUrl
    };
    
    console.log('üì§ [SAVE] Datos a guardar:', vacancyData);
    
    if (state.editingVacancy) {
      console.log('‚úèÔ∏è [SAVE] Actualizando vacante ID:', state.editingVacancy.id);
      const { error } = await supabaseClient.from('vacancies').update(vacancyData).eq('id', state.editingVacancy.id);
      if (error) throw error;
      showModal('success', 'Actualizado', 'Vacante actualizada correctamente');
    } else {
      console.log('‚ûï [SAVE] Creando nueva vacante');
      const { error } = await supabaseClient.from('vacancies').insert([vacancyData]);
      if (error) throw error;
      showModal('success', 'Publicado', 'Vacante publicada correctamente');
    }
    
    state.editingVacancy = null;
    state.view = 'dashboard';
    resetJobForm();
    await loadVacancies();
  } catch (error) {
    console.error('‚ùå [SAVE] Error:', error);
    showModal('error', 'Error', error.message);
  } finally {
    hideLoading();
  }
}

// Funciones del Chat IA
function toggleAIChat() {
  console.log('ü§ñ [IA] Toggle chat:', !state.aiChatOpen);
  state.aiChatOpen = !state.aiChatOpen;
  if (state.aiChatOpen && state.aiMessages.length === 0) {
    state.aiMessages = [{
      role: 'bot',
      content: '¬°Hola! ¬øTienes alguna informaci√≥n para compartirme para llenar el formulario? Puedes enviarme texto o una imagen con los datos de la vacante.'
    }];
  }
  render();
}

async function sendAIMessage() {
  const input = document.getElementById('ai-chat-input');
  const message = input?.value.trim();
  if (!message && !state.aiImage) {
    console.log('üìù [IA] No hay mensaje ni imagen');
    return;
  }
  
  if (message) {
    state.aiMessages.push({ role: 'user', content: message });
    console.log('üì§ [IA] Mensaje del usuario:', message);
  }
  
  state.aiLoading = true;
  render();
  
  try {
    console.log('üöÄ [IA] Enviando solicitud a Edge Function...');
    const requestData = { text: message || '' };
    
    if (state.aiImage) {
      const reader = new FileReader();
      const base64 = await new Promise((resolve) => {
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(state.aiImage);
      });
      requestData.image = base64;
      console.log('üñºÔ∏è [IA] Imagen incluida en solicitud');
    }
    
    const response = await fetch(`${SUPABASE_URL}/functions/v1/extract-vacancy`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify(requestData)
    });
    
    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('‚úÖ [IA] Respuesta recibida:', data);
    
    const modelInfo = data.model ? ` (usando ${data.model})` : '';
    state.aiMessages.push({
      role: 'bot',
      content: `He procesado tu informaci√≥n${modelInfo}. Presiona "START" para rellenar el formulario.`
    });
    
    // üîß LIMPIAR DATOS DE LA IA ANTES DE GUARDAR
    if (data.vacancyData) {
      state.aiExtractedData = cleanAIData(data.vacancyData); // üî• DATOS LIMPIOS
      console.log('üíæ [IA] Datos extra√≠dos y limpiados:', state.aiExtractedData);
    }
  } catch (error) {
    console.error('‚ùå [IA] Error al procesar:', error);
    state.aiMessages.push({
      role: 'bot',
      content: `Error: ${error.message}. Verifica que la Edge Function est√© activa en Supabase.`
    });
  } finally {
    state.aiLoading = false;
    if (input) input.value = '';
    state.aiImage = null;
    state.aiImagePreview = null;
    render();
  }
}

// üîß FUNCI√ìN CORREGIDA: Respetar ediciones manuales
function startAutofill() {
  console.log('üöÄ [IA] Iniciando autofill');
  if (!state.aiExtractedData) {
    console.log('‚ùå [IA] No hay datos extra√≠dos');
    showModal('info', 'Informaci√≥n', 'Primero env√≠a la informaci√≥n que deseas procesar.');
    return;
  }
  
  const data = state.aiExtractedData;
  
  // üî• SOLO LLENAR CAMPOS VAC√çOS (respetar lo que ya escribiste)
  if (!state.formData.company && data.company) state.formData.company = data.company;
  if (!state.formData.job_title && data.job_title) state.formData.job_title = data.job_title;
  if (!state.formData.description && data.description) state.formData.description = data.description;
  if (!state.formData.location && data.location) state.formData.location = data.location;
  if (!state.formData.contact_phone && data.contact_phone) state.formData.contact_phone = cleanPhoneNumber(data.contact_phone);
  if (!state.formData.contact_email && data.contact_email) state.formData.contact_email = data.contact_email;
  if (!state.formData.schedule && data.schedule) state.formData.schedule = data.schedule;
  if (!state.formData.work_days && data.work_days) state.formData.work_days = data.work_days;
  
  console.log('‚úÖ [IA] Formulario rellenado con:', state.formData);
  
  state.aiChatOpen = false;
  state.aiMessages = [];
  state.aiExtractedData = null;
  showModal('success', '¬°√âxito!', 'Formulario rellenado autom√°ticamente.');
  render();
}

// Funciones de formulario
function cleanForm() {
  console.log('üßπ [FORM] Limpiando formulario');
  resetJobForm();
  render();
  showModal('info', 'Formulario Limpiado', 'Todos los campos han sido vaciados');
}

function cancelForm() {
  console.log('‚ùå [FORM] Cancelando formulario');
  state.editingVacancy = null;
  state.view = 'dashboard';
  resetJobForm();
  render();
}

function resetAuthForm() {
  console.log('üßπ [AUTH] Reset auth form');
  state.formData.email = '';
  state.formData.password = '';
  state.formData.confirmPassword = '';
}

function resetJobForm() {
  console.log('üßπ [JOB] Reset job form');
  state.formData.company = '';
  state.formData.job_title = '';
  state.formData.description = '';
  state.formData.location = '';
  state.formData.contact_phone = '';
  state.formData.contact_email = '';
  state.formData.schedule = '';
  state.formData.work_days = '';
  state.formData.imageUrl = '';
}

// Funciones de renderizado (simplificadas para evitar refresh innecesario)
function renderLogin() {
  return `
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden fade-in">
        <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white text-center">
          <h1 class="text-3xl font-black mb-2">Portal de Empleos</h1>
          <p class="text-purple-200 text-sm font-semibold">Le√≥n, Guanajuato</p>
        </div>
        <div class="p-8">
          <form onsubmit="handleLogin(event)">
            <div class="input-group">
              <label>Correo Electr√≥nico</label>
              <input type="email" required placeholder="tu@email.com" value="${state.formData.email}" oninput="state.formData.email=this.value">
            </div>
            <div class="input-group">
              <label>Contrase√±a</label>
              <input type="${state.showPassword ? 'text' : 'password'}" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="${state.formData.password}" oninput="state.formData.password=this.value">
            </div>
            <button type="submit" class="btn btn-primary w-full mb-3" ${state.loading ? 'disabled' : ''}>
              ${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Ingresando...' : '<i class="fas fa-sign-in-alt"></i> Ingresar'}
            </button>
          </form>
        </div>
      </div>
    </div>
  `;
}

function renderDashboard() {
  return `
    <div class="min-h-screen">
      <header class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
          <h1 class="text-2xl font-black text-gray-800">Portal de Empleos</h1>
        </div>
      </header>
      <main class="max-w-7xl mx-auto px-4 py-8">
        <button onclick="state.view='form';render()" class="btn btn-primary mb-6">
          <i class="fas fa-plus"></i> Nueva Vacante
        </button>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          ${state.vacancies.map(v => `
            <div class="vacancy-card fade-in">
              <div class="h-48 bg-gradient-to-br from-purple-400 to-purple-600 relative overflow-hidden">
                ${v.image_url ? `<img src="${v.image_url}" class="w-full h-full object-cover" alt="${v.company}">` : ''}
              </div>
              <div class="p-6">
                <h3 class="text-xl font-black mb-2">${v.company}</h3>
                <p class="text-gray-600">${v.job_title}</p>
              </div>
            </div>
          `).join('')}
        </div>
      </main>
    </div>
  `;
}

function renderForm() {
  return `
    <div class="min-h-screen py-8">
      <div class="max-w-3xl mx-auto px-4">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden fade-in">
          <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-8 text-white">
            <h2 class="text-3xl font-black mb-2">${state.editingVacancy ? 'Editar Vacante' : 'Nueva Vacante'}</h2>
          </div>
          <form onsubmit="handleSaveVacancy(event)" class="p-8 space-y-6">
            <div class="input-group">
              <label>Empresa *</label>
              <input type="text" required placeholder="Ej: Calzado Le√≥n" value="${state.formData.company}" oninput="state.formData.company=this.value">
            </div>
            <div class="input-group">
              <label>Puesto *</label>
              <input type="text" required placeholder="Ej: Desarrollador" value="${state.formData.job_title}" oninput="state.formData.job_title=this.value">
            </div>
            <div class="input-group">
              <label>Descripci√≥n *</label>
              <textarea rows="5" required placeholder="Describe el puesto..." oninput="state.formData.description=this.value">${state.formData.description}</textarea>
            </div>
            <div class="input-group">
              <label>WhatsApp</label>
              <input type="tel" placeholder="4771234567" value="${state.formData.contact_phone}" oninput="state.formData.contact_phone=this.value.replace(/\\D/g,'')">
            </div>
            <div class="form-buttons-container pt-4">
              <button type="button" onclick="cancelForm()" class="btn btn-cancel w-full sm:flex-1">
                <i class="fas fa-times"></i> Cancelar
              </button>
              <button type="button" onclick="cleanForm()" class="btn btn-clean w-full sm:flex-1">
                <i class="fas fa-eraser"></i> Limpiar
              </button>
              <button type="button" onclick="toggleAIChat()" class="btn btn-autofill w-full sm:flex-1">
                <i class="fas fa-robot"></i> Autofill IA
              </button>
              <button type="submit" class="btn btn-save w-full sm:flex-1" ${state.loading ? 'disabled' : ''}>
                ${state.loading ? '<i class="fas fa-spinner fa-spin"></i> Guardando...' : '<i class="fas fa-save"></i> Publicar'}
              </button>
            </div>
          </form>
        </div>
      </div>
      ${state.aiChatOpen ? renderAIChat() : ''}
    </div>
  `;
}

function renderAIChat() {
  return `
    <div class="ai-chat-modal" onmousedown="startDrag(event)">
      <div class="ai-chat-header">
        <h3><i class="fas fa-robot mr-2"></i>Autofill IA</h3>
        <button class="close-btn" onclick="state.aiChatOpen=false;render()" title="Cerrar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="ai-chat-messages">
        ${state.aiMessages.map(msg => `
          <div class="ai-message ${msg.role}">
            ${msg.content}
          </div>
        `).join('')}
        ${state.aiLoading ? `
          <div class="ai-message bot">
            <span class="ai-loading"></span> Procesando...
          </div>
        ` : ''}
      </div>
      <div class="ai-chat-input">
        <textarea id="ai-chat-input" placeholder="Describe la vacante..." rows="3"></textarea>
        <div class="ai-chat-actions">
          <button class="btn-send" onclick="sendAIMessage()">
            <i class="fas fa-paper-plane"></i> Enviar
          </button>
          <button class="btn-start" onclick="startAutofill()">
            <i class="fas fa-play"></i> START
          </button>
        </div>
      </div>
    </div>
  `;
}

function render() {
  const app = document.getElementById('app');
  let content = '';
  switch (state.view) {
    case 'login': content = renderLogin(); break;
    case 'dashboard': content = renderDashboard(); break;
    case 'form': content = renderForm(); break;
    default: content = renderLogin();
  }
  app.innerHTML = content;
  console.log(`‚úÖ [RENDER] Vista actual: ${state.view}`);
}

// Inicializaci√≥n
async function init() {
  console.log('üöÄ [INIT] Iniciando aplicaci√≥n...');
  const { data, error } = await supabaseClient.auth.getSession();
  if (data.session) {
    console.log('‚úÖ [INIT] Sesi√≥n activa:', data.session.user.email);
    state.user = data.session.user;
    const accepted = localStorage.getItem('terms_accepted_' + data.session.user.id);
    state.acceptedTerms = !!accepted;
    state.view = accepted ? 'dashboard' : 'terms';
    await loadVacancies();
  }
  render();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
console.log('‚úÖ [CARGA] Script cargado completamente');
</script>
</body>
</html>
